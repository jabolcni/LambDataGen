<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lamb Distributed Runner – Full Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    pre.code { background: #f4f4f4; padding: 1rem; border-radius: 8px; overflow-x: auto; }
    .copy-btn { font-size: 0.8rem; }
    details { margin-bottom: 1rem; }
    summary { cursor: pointer; font-weight: bold; }
  </style>
</head>
<body class="bg-light">

<div class="container py-5">
  <h1 class="display-5 text-center mb-4">Lamb Distributed Runner – Full System Plan</h1>
  <p class="lead text-center mb-5">Ubuntu + Python + Flask + Multiprocessing</p>

  <!-- Overview -->
  <div class="card mb-4">
    <div class="card-header"><h2>System Overview</h2></div>
    <div class="card-body">
      <pre class="code">
+-------------------+     HTTP/JSON          +-------------------+
|   Server (Flask)  | <----   -------------> |  Client (Python)  |
|  - Web GUI        |                        |  - Registers      |
|  - API            |                        |  - Pulls params   |
|  - Stores state   |                        |  - Runs ./lamb    |
+-------------------+                        |  - Reports prog.  |
        ^                                    +-------------------+
        |                                           ^   ^   ^
        |                                           |   |   |
   Multiple computers (each with a unique name/IP)  |   |   |
                                                   Clients on cores
      </pre>
      <p>One <strong>server</strong> on your workstation. Every worker runs a <strong>client</strong>. Each client spawns <code>N</code> concurrent <code>./lamb</code> processes.</p>
    </div>
  </div>

  <!-- Server -->
  <div class="card mb-4">
    <div class="card-header"><h2>1. Flask Server (<code>server.py</code>)</h2></div>
    <div class="card-body">
      <p>Run on your main computer. Serves GUI + REST API.</p>
      <details>
        <summary>Click to show full server code</summary>
        <pre class="code position-relative">
from flask import Flask, request, jsonify, render_template_string
import uuid, datetime, random, string, os

app = Flask(__name__)

# In-memory state
clients = {}
parameters = {
    "num_games": 1000,
    "param1_name": "seed",
    "param1_value": "42",
    "option1_true": "true"
}
parameters_changed = True

HTML_GUI = """
&lt;!doctype html&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Lamb Controller&lt;/title&gt;
&lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"&gt;
&lt;/head&gt;&lt;body class="container mt-4"&gt;
&lt;h1&gt;Lamb Distributed Runner&lt;/h1&gt;

&lt;h3&gt;Clients&lt;/h3&gt;
&lt;table class="table table-sm"&gt;
  &lt;thead&gt;&lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;IP&lt;/th&gt;&lt;th&gt;Last seen&lt;/th&gt;&lt;th&gt;Progress&lt;/th&gt;&lt;th&gt;File&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;
  &lt;tbody&gt;
    {% for c in clients %}
    &lt;tr&gt;
      &lt;td&gt;{{ c.name }}&lt;/td&gt;&lt;td&gt;{{ c.ip }}&lt;/td&gt;&lt;td&gt;{{ c.last_seen }}&lt;/td&gt;
      &lt;td&gt;{{ c.progress }}&lt;/td&gt;&lt;td&gt;{{ c.output_file|default("") }}&lt;/td&gt;
    &lt;/tr&gt;
    {% endfor %}
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3&gt;Set Parameters&lt;/h3&gt;
&lt;form method="post" action="/set_parameters"&gt;
  &lt;div class="row g-2"&gt;
    &lt;div class="col-md-2"&gt;&lt;label class="form-label"&gt;num_games&lt;/label&gt;&lt;input name="num_games" class="form-control" value="{{ params.num_games }}"&gt;&lt;/div&gt;
    &lt;div class="col-md-2"&gt;&lt;label class="form-label"&gt;param1_name&lt;/label&gt;&lt;input name="param1_name" class="form-control" value="{{ params.param1_name }}"&gt;&lt;/div&gt;
    &lt;div class="col-md-2"&gt;&lt;label class="form-label"&gt;param1_value&lt;/label&gt;&lt;input name="param1_value" class="form-control" value="{{ params.param1_value }}"&gt;&lt;/div&gt;
    &lt;div class="col-md-2"&gt;&lt;label class="form-label"&gt;option1_true&lt;/label&gt;&lt;input name="option1_true" class="form-control" value="{{ params.option1_true }}"&gt;&lt;/div&gt;
    &lt;div class="col-md-2 d-flex align-items-end"&gt;&lt;button class="btn btn-primary"&gt;Update&lt;/button&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/form&gt;
&lt;/body&gt;&lt;/html&gt;
"""

@app.route("/")
def gui():
    return render_template_string(HTML_GUI, clients=clients.values(), params=parameters)

@app.route("/register", methods=["POST"])
def register():
    data = request.json
    client_id = str(uuid.uuid4())
    clients[client_id] = {
        "name": data["name"],
        "ip": request.remote_addr,
        "last_seen": datetime.datetime.utcnow().isoformat(),
        "progress": "registered"
    }
    return jsonify({"client_id": client_id})

@app.route("/parameters", methods=["GET"])
def get_parameters():
    global parameters_changed
    changed = parameters_changed
    parameters_changed = False
    return jsonify({"parameters": parameters, "changed": changed})

@app.route("/progress", methods=["POST"])
def receive_progress():
    data = request.json
    cid = data["client_id"]
    if cid in clients:
        clients[cid].update({
            "progress": data["progress"],
            "output_file": data.get("output_file"),
            "last_seen": datetime.datetime.utcnow().isoformat()
        })
    return jsonify({"status": "ok"})

@app.route("/set_parameters", methods=["POST"])
def set_parameters():
    global parameters, parameters_changed
    for key in parameters.keys():
        if key in request.form:
            val = request.form[key]
            parameters[key] = type(parameters[key])(val) if val.isdigit() else val
    parameters_changed = True
    return gui()

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=False)
        </pre>
        <button class="btn btn-sm btn-outline-secondary copy-btn position-absolute top-0 end-0 m-2" onclick="copyCode(this)">Copy</button>
      </details>
    </div>
  </div>

  <!-- Client -->
  <div class="card mb-4">
    <div class="card-header"><h2>2. Client Script (<code>client.py</code>)</h2></div>
    <div class="card-body">
      <p>Run on every worker machine. Uses <code>multiprocessing</code> for concurrency.</p>
      <details>
        <summary>Click to show full client code</summary>
        <pre class="code position-relative">
import requests, json, time, subprocess, multiprocessing, socket, os, datetime, random, string
from pathlib import Path

SERVER = "http://YOUR_SERVER_IP:5000"  # CHANGE THIS
CLIENT_ID_FILE = Path("/tmp/lamb_client_id")
CONCURRENCY = 4  # Change per machine

def register():
    payload = {"name": socket.gethostname()}
    r = requests.post(f"{SERVER}/register", json=payload)
    cid = r.json()["client_id"]
    CLIENT_ID_FILE.write_text(cid)
    return cid

def get_client_id():
    return CLIENT_ID_FILE.read_text().strip() if CLIENT_ID_FILE.exists() else register()

def fetch_parameters():
    r = requests.get(f"{SERVER}/parameters")
    return r.json()["parameters"], r.json()["changed"]

def report_progress(cid, prog, outfile=None):
    payload = {"client_id": cid, "progress": prog}
    if outfile: payload["output_file"] = outfile
    try: requests.post(f"{SERVER}/progress", json=payload, timeout=5)
    except: pass

def make_output_name(comp_name):
    now = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    uniq = ''.join(random.choices(string.ascii_uppercase, k=4))
    return f"data_{now}_{comp_name}_{uniq}"

def run_one_instance(params, comp_name, cid):
    outfile = make_output_name(comp_name)
    cmd = [
        "./lamb", "games", str(params["num_games"]),
        params["param1_name"], str(params["param1_value"]),
        params["option1_true"], outfile
    ]
    report_progress(cid, f"starting {outfile}")
    subprocess.run(cmd, check=True)
    report_progress(cid, f"finished {outfile}", outfile)

def worker_task(params, comp_name, cid):
    try: run_one_instance(params, comp_name, cid)
    except Exception as e: report_progress(cid, f"error: {e}")

def main():
    cid = get_client_id()
    comp_name = socket.gethostname()
    last_params = None

    while True:
        params, changed = fetch_parameters()
        if changed or last_params != params:
            report_progress(cid, "launching new batch")
            last_params = params.copy()
            with multiprocessing.Pool(processes=CONCURRENCY) as pool:
                jobs = [pool.apply_async(worker_task, (params, comp_name, cid)) for _ in range(CONCURRENCY)]
                for j in jobs: j.get()
            report_progress(cid, "batch completed")
        else:
            report_progress(cid, "waiting for changes")
        time.sleep(15)

if __name__ == "__main__":
    main()
        </pre>
        <button class="btn btn-sm btn-outline-secondary copy-btn position-absolute top-0 end-0 m-2" onclick="copyCode(this)">Copy</button>
      </details>
    </div>
  </div>

  <!-- File Naming -->
  <div class="card mb-4">
    <div class="card-header"><h2>3. Output File Naming</h2></div>
    <div class="card-body">
      <p><code>data_YYYYMMDD_HHMMSS_nameOfComp_ABCD</code></p>
      <ul>
        <li><code>YYYYMMDD_HHMMSS</code> – start time</li>
        <li><code>nameOfComp</code> – <code>socket.gethostname()</code></li>
        <li><code>ABCD</code> – random 4 uppercase letters</li>
      </ul>
    </div>
  </div>

  <!-- Deployment -->
  <div class="card mb-4">
    <div class="card-header"><h2>4. Deployment on Ubuntu</h2></div>
    <div class="card-body">
      <h5>Server Machine</h5>
      <pre class="code">pip install flask
python server.py</pre>

      <h5>Worker Machines</h5>
      <pre class="code">pip install requests
# Copy client.py and ./lamb here
nohup python client.py &</pre>

      <h5>Firewall</h5>
      <pre class="code">sudo ufw allow 5000/tcp</pre>
    </div>
  </div>

  <!-- Final Steps -->
  <div class="card mb-4">
    <div class="card-header"><h2>5. Final Workflow</h2></div>
    <div class="card-body">
      <ol>
        <li>Start <code>server.py</code> on your workstation.</li>
        <li>Deploy <code>client.py</code> + <code>./lamb</code> to all nodes.</li>
        <li>Run clients: <code>python client.py</code>.</li>
        <li>Open browser: <code>http://&lt;server-ip&gt;:5000</code>.</li>
        <li>Change parameters → all clients auto-restart with new settings.</li>
      </ol>
    </div>
  </div>
</div>

<script>
function copyCode(btn) {
  const pre = btn.parentElement.querySelector('pre');
  navigator.clipboard.writeText(pre.textContent).then(() => {
    const original = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = original, 2000);
  });
}
</script>

</body>
</html>